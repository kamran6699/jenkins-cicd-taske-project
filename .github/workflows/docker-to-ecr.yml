name: Build and Push Docker Image to AWS ECR

# Run on every push to main and when manually triggered
on:
  push:
    branches: [main]
  workflow_dispatch:      # allows the green ‚ÄúRun workflow‚Äù button

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    # Make the region available to every step
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}

    steps:
    # 1Ô∏è‚É£ Checkout source
    - name: Checkout code
      uses: actions/checkout@v3

    # 2Ô∏è‚É£ Configure AWS credentials (uses your three secrets)
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    # 3Ô∏è‚É£ Log in to ECR (region is now passed explicitly)
    - name: Log in to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1
      with:
        region: ${{ env.AWS_REGION }}

    # 4Ô∏è‚É£ Build, tag, and push image
    - name: Build, tag, and push image to ECR
      env:
        ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
        ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
      run: |
        IMAGE_URI=$ECR_REGISTRY/$ECR_REPOSITORY:latest

        echo "üî® Building Docker image‚Ä¶"
        docker build -t $IMAGE_URI .

        echo "üìù Tagging image‚Ä¶"
        docker tag $IMAGE_URI $IMAGE_URI

        echo "üöÄ Pushing to Amazon ECR‚Ä¶"
        docker push $IMAGE_URI
